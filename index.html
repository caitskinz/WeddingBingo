<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Wedding Bingo</title>
    <style>
      :root {
        --gap: 10px;
        --radius: 14px;
        --shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        background: #fffbf0;
        color: #111;
      }

      .topbar {
        background: #fdfbf2;
        padding: 14px 14px 10px;
        border-bottom: 2px dashed #692751;
        z-index: 10;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .logo {
        display: block;
        width: min(240px, 70%);
        height: auto;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      h1 {
        font-size: 22px;
        margin: 0 0 10px;
        text-align: center;
        font-weight: 900;
        letter-spacing: 1px;
        color: #692751;
      }

      .actions {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 10px;
        max-width: 820px;
      }

      button {
        padding: 10px 12px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 12px;
        box-shadow: var(--shadow);
        font-weight: 700;

        color: #111; /* stop iOS blue */
        -webkit-text-fill-color: #111; /* stop iOS blue */
        -webkit-appearance: none;
        appearance: none;
      }
      button:active {
        transform: translateY(1px);
      }

      .status {
        margin: 0;
        font-size: 13px;
        color: #444;
        display: none; /* turn on if you want */
      }

      main {
        padding: 14px;
        max-width: 820px;
        margin: 0 auto;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: var(--gap);
      }

      .square {
        user-select: none;
        padding: 10px;
        border-radius: var(--radius);
        border: 1px solid #e7e7e7;
        background: #fff;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        line-height: 1.2;
        font-weight: 650;
        font-size: 14px;
        aspect-ratio: 1 / 1;
        transition:
          transform 0.12s ease,
          background 0.2s ease,
          color 0.2s ease;
      }

      .square.checked {
    
        background: #2a444d;
        color: #fff;
        -webkit-text-fill-color: #fff; /* iOS */
      }

      /* Squares that are part of a completed line */
      .square.checked.linewin {
        background: #692751;
        color: #fff;
        -webkit-text-fill-color: #fff;
        border-color: #fff;
        box-shadow:
          0 0 0 3px #fff inset,
          var(--shadow);
      }

      .badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid #ddd;
        background: #fff;
        box-shadow: var(--shadow);
        font-weight: 800;
        font-size: 13px;
      }

      /* --- Bingo overlay --- */
      .overlay[hidden] {
        display: none;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: grid;
        place-items: center;
        z-index: 9999;
        padding: 20px;
      }
      .overlay-card {
        width: min(420px, 92vw);
        background: white;
        border-radius: 18px;
        padding: 18px 16px;
        box-shadow: 0 18px 60px rgba(0, 0, 0, 0.25);
        text-align: center;
        position: relative;
      }
      .overlay-title {
        font-size: 28px;
        font-weight: 900;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
      }
      .overlay-sub {
        font-size: 14px;
        opacity: 0.75;
        margin-bottom: 12px;
      }
      .overlay-actions {
        display: flex;
        justify-content: center;
      }

      /* --- Confetti (CSS only) --- */
      .confetti {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
      }
      .confetti i {
        position: absolute;
        top: -12px;
        width: 10px;
        height: 14px;
        opacity: 0.95;
        transform: rotate(10deg);
        animation: fall 1100ms linear forwards;
        border-radius: 3px;
      }
      @keyframes fall {
        to {
          transform: translateY(110vh) rotate(360deg);
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <header class="topbar">
      <!-- Optional: remove if not needed -->
      <img
        class="logo"
        src="https://raw.githubusercontent.com/caitskinz/ElectricAve26/refs/heads/main/MHLogo.png"
        alt="Wedding"
      />
      <h1>Wedding Bingo</h1>

      <div class="actions">
        <button id="newBoardBtn" type="button">Reshuffle</button>
        <button id="resetTicksBtn" type="button">Clear</button>
      </div>

      <p class="status" id="status"></p>
    </header>

    <main>
      <section class="grid" id="grid" aria-label="Bingo grid"></section>
    </main>

    <div id="bingoOverlay" class="overlay" hidden>
      <div class="overlay-card">
        <div class="overlay-title">BINGO! ðŸŽ‰</div>
        <div class="overlay-sub">ur prize is a hangover</div>
        <div class="overlay-actions">
          <button id="closeOverlayBtn" type="button">Congrats ðŸ¥‚</button>
        </div>
      </div>
      <div id="confetti" class="confetti" aria-hidden="true"></div>
    </div>

    <script>
      /* =========================
         Wedding Bingo (One day)
         - Fetches one published Google Sheet CSV (Column A only)
         - 4x4 grid (16 tiles)
         - Saves board + ticks + wins locally
         - Offline-friendly with sw.js
         - Line highlights + full-grid celebration
         ========================= */

      const SHEET_CSV_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8p_z-38uiG_0kKaajRrRDHmWHa-wmbxbmqJRB-NHtsxhUTNOddGU1iS72Bslf9ZOP-nud7JWnN9zX/pub?output=csv"; // Column A ideas, header row optional
      const GRID_DIM = 4;
      const GRID_SIZE = GRID_DIM * GRID_DIM; // 16
      const IDEAS_NEEDED = GRID_SIZE;

      const STORE_KEY = "wedding-bingo-v1-state";
      const OPTIONS_CACHE_KEY = "wedding-bingo-v1-options-cache";
      const WINS_KEY = "wedding-bingo-v1-wins";

      function $(id) {
        return document.getElementById(id);
      }
      function setStatus(msg) {
        const el = $("status");
        if (el) el.textContent = msg;
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }
      function saveState(state) {
        localStorage.setItem(STORE_KEY, JSON.stringify(state));
      }

      function loadWins() {
        try {
          return Number(localStorage.getItem(WINS_KEY) || "0");
        } catch {
          return 0;
        }
      }
      function saveWins(wins) {
        localStorage.setItem(WINS_KEY, String(wins));
      }

      function loadCachedOptions() {
        try {
          const raw = localStorage.getItem(OPTIONS_CACHE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }
      function saveCachedOptions(items) {
        localStorage.setItem(
          OPTIONS_CACHE_KEY,
          JSON.stringify({ savedAt: new Date().toISOString(), items }),
        );
      }

      function randomInt(min, maxExclusive) {
        const range = maxExclusive - min;
        if (range <= 0) return min;

        if (crypto?.getRandomValues) {
          const maxUint = 0xffffffff;
          const limit = maxUint - (maxUint % range);
          const buf = new Uint32Array(1);
          while (true) {
            crypto.getRandomValues(buf);
            const x = buf[0];
            if (x < limit) return min + (x % range);
          }
        }
        return min + Math.floor(Math.random() * range);
      }

      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = randomInt(0, i + 1);
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      // Robust CSV parsing (handles commas/quotes)
      function parseCSVToRows(text) {
        const rows = [];
        let row = [];
        let field = "";
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const c = text[i];
          const next = text[i + 1];

          if (inQuotes) {
            if (c === '"' && next === '"') {
              field += '"';
              i++;
            } else if (c === '"') inQuotes = false;
            else field += c;
          } else {
            if (c === '"') inQuotes = true;
            else if (c === ",") {
              row.push(field);
              field = "";
            } else if (c === "\n") {
              row.push(field);
              rows.push(row);
              row = [];
              field = "";
            } else if (c === "\r") {
              /* ignore */
            } else field += c;
          }
        }

        row.push(field);
        rows.push(row);
        return rows;
      }

      // Column A only; if first row is a header ("Wedding", "Bingo", etc), we skip it automatically if it looks header-ish.
      function extractIdeasFromCSV(text) {
        const rows = parseCSVToRows(text);
        const items = rows.map((r) => (r[0] ?? "").trim()).filter(Boolean);

        // If you have a header in A1, remove it:
        // heuristic: if first cell contains "day" or "wedding" or "bingo", drop it
        if (items.length && /day|wedding|bingo/i.test(items[0])) items.shift();

        return items;
      }

      function makeNewBoardFromOptions(items) {
        const pool = [...items];
        shuffleInPlace(pool);
        const board = pool.slice(0, GRID_SIZE);

        return {
          createdAt: new Date().toISOString(),
          board,
          checked: Array(GRID_SIZE).fill(false),
          celebratedFull: false,
        };
      }

      function isFullGrid(checked) {
        return checked.every(Boolean);
      }

      function getWinLines() {
        const lines = [];

        for (let r = 0; r < GRID_DIM; r++) {
          const line = [];
          for (let c = 0; c < GRID_DIM; c++) line.push(r * GRID_DIM + c);
          lines.push(line);
        }
        for (let c = 0; c < GRID_DIM; c++) {
          const line = [];
          for (let r = 0; r < GRID_DIM; r++) line.push(r * GRID_DIM + c);
          lines.push(line);
        }
        lines.push([0, 5, 10, 15]);
        lines.push([3, 6, 9, 12]);

        return lines;
      }

      const WIN_LINES = getWinLines();

      function getLineWinSet(checked) {
        const winners = new Set();
        for (const line of WIN_LINES) {
          if (line.every((i) => checked[i]))
            line.forEach((i) => winners.add(i));
        }
        return winners;
      }

      function vibrate(ms = 40) {
        try {
          navigator.vibrate?.(ms);
        } catch {}
      }

      let audioCtx = null;
      function playWinSound() {
        try {
          audioCtx =
            audioCtx ||
            new (window.AudioContext || window.webkitAudioContext)();
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = "sine";
          o.frequency.value = 740;
          g.gain.value = 0.0001;

          o.connect(g);
          g.connect(audioCtx.destination);

          const now = audioCtx.currentTime;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);

          o.start(now);
          o.stop(now + 0.2);
        } catch {}
      }

      function burstConfetti() {
        const confetti = $("confetti");
        if (!confetti) return;

        confetti.innerHTML = "";
        const pieces = 40;

        for (let i = 0; i < pieces; i++) {
          const p = document.createElement("i");
          const left = randomInt(0, 100);
          const delay = randomInt(0, 250);
          const dur = randomInt(900, 1400);
          const w = randomInt(6, 12);
          const h = randomInt(10, 18);

          p.style.left = `${left}vw`;
          p.style.animationDelay = `${delay}ms`;
          p.style.animationDuration = `${dur}ms`;
          p.style.width = `${w}px`;
          p.style.height = `${h}px`;

          const palette = [
            "#111",
            "#ff3b30",
            "#ffcc00",
            "#34c759",
            "#0a84ff",
            "#bf5af2",
          ];
          p.style.background = palette[randomInt(0, palette.length)];
          p.style.transform = `rotate(${randomInt(0, 360)}deg)`;

          confetti.appendChild(p);
        }

        setTimeout(() => {
          confetti.innerHTML = "";
        }, 1600);
      }

      function showBingoOverlay() {
        const overlay = $("bingoOverlay");
        if (!overlay) return;
        overlay.hidden = false;
        burstConfetti();
      }

      function hideBingoOverlay() {
        const overlay = $("bingoOverlay");
        if (!overlay) return;
        overlay.hidden = true;
      }

      function ensureWinsBadge() {
        const statusEl = $("status");
        if (statusEl && !$("winsBadge")) {
          const badge = document.createElement("span");
          badge.id = "winsBadge";
          badge.className = "badge";
          badge.style.marginLeft = "10px";
          badge.textContent = `Wins: ${loadWins()}`;
          statusEl.appendChild(badge);
        }
      }

      function updateWinBadge() {
        const el = $("winsBadge");
        if (el) el.textContent = `Wins: ${loadWins()}`;
      }

      let options = [];
      let state = null;

      async function fetchOptions() {
        const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        const text = await res.text();

        const items = extractIdeasFromCSV(text);
        if (items.length < IDEAS_NEEDED) {
          throw new Error(
            `Need at least ${IDEAS_NEEDED} ideas (found ${items.length}).`,
          );
        }
        return items;
      }

      function renderBoard() {
        const grid = $("grid");
        if (!grid || !state) return;

        grid.innerHTML = "";

        const lineWins = getLineWinSet(state.checked);

        state.board.forEach((text, idx) => {
          const btn = document.createElement("button");
          btn.type = "button";

          const isChecked = !!state.checked[idx];
          const isLineWin = lineWins.has(idx);

          btn.className =
            "square" +
            (isChecked ? " checked" : "") +
            (isLineWin ? " linewin" : "");
          btn.textContent = text;

          btn.addEventListener("click", () => {
            state.checked[idx] = !state.checked[idx];

            const full = isFullGrid(state.checked);

            if (full && !state.celebratedFull) {
              state.celebratedFull = true;

              const wins = loadWins() + 1;
              saveWins(wins);
              updateWinBadge();

              vibrate(80);
              playWinSound();
              showBingoOverlay();
            }

            if (!full && state.celebratedFull) {
              state.celebratedFull = false;
            }

            saveState(state);
            renderBoard(); // re-render to update line highlights
          });

          grid.appendChild(btn);
        });

        updateWinBadge();
      }

      function wireUI() {
        $("newBoardBtn")?.addEventListener("click", () => {
          if (!options?.length) {
            setStatus("Squares list not loaded yet â€” go online once.");
            return;
          }
          state = makeNewBoardFromOptions(options);
          saveState(state);
          renderBoard();
        });

        $("resetTicksBtn")?.addEventListener("click", () => {
          if (!state) return;
          state.checked = Array(GRID_SIZE).fill(false);
          state.celebratedFull = false;
          saveState(state);
          renderBoard();
        });

        $("closeOverlayBtn")?.addEventListener("click", hideBingoOverlay);

        $("bingoOverlay")?.addEventListener("click", (e) => {
          if (e.target && e.target.id === "bingoOverlay") hideBingoOverlay();
        });
      }

      async function registerServiceWorker() {
        if (!("serviceWorker" in navigator)) return;
        try {
          await navigator.serviceWorker.register(
            new URL("sw.js", window.location.href),
          );
        } catch (e) {
          console.warn("Service worker registration failed:", e);
        }
      }

      (async function init() {
        await registerServiceWorker();
        wireUI();
        ensureWinsBadge();

        state = loadState();

        try {
          setStatus("Loading squaresâ€¦");
          options = await fetchOptions();
          saveCachedOptions(options);

          if (!state) {
            state = makeNewBoardFromOptions(options);
            saveState(state);
          } else {
            if (typeof state.celebratedFull !== "boolean")
              state.celebratedFull = false;
          }
        } catch (e) {
          const cached = loadCachedOptions();
          if (cached?.items?.length >= IDEAS_NEEDED) {
            options = cached.items;
            if (!state) {
              state = makeNewBoardFromOptions(options);
              saveState(state);
            } else {
              if (typeof state.celebratedFull !== "boolean")
                state.celebratedFull = false;
            }
          } else if (!state?.board?.length) {
            console.error(e);
            setStatus("Couldnâ€™t load squares. Go online once to set up.");
            return;
          }
        }

        renderBoard();
      })();
    </script>
  </body>
</html>
